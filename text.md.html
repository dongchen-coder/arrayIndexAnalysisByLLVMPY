<!DOCTYPE html>
<html>
<head>
    <title>Markdown to HTML</title>
    <link rel='stylesheet' href='github-markdown.css' />
</head>
<body class='github-markdown'>


<h1 id="tutorial-for-iterating-over-a-python-list">Tutorial for Iterating Over a Python List</h1>
<p>Dong Chen</p>
<h2 id="introduction">Introduction</h2>
<p>A Python list is an ordered sequence of items which don’t have to be of the same type. Numbers, letters, strings, nested lists can on the same list.</p>
<p><b>List creation:</b></p>
<p>The plain way to create a Python list is just by statically writing the items between square brackets.</p>
<pre class="editor-colors lang-python"><div class="line"><span class="source python"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="support type python"><span>list</span></span><span>&nbsp;＝&nbsp;［&nbsp;</span><span class="constant numeric integer decimal python"><span>1</span></span><span>，‘</span><span>a</span><span>’，&nbsp;“</span><span>hello</span><span>”，&nbsp;</span><span>sublist</span><span>，&nbsp;</span><span class="meta function-call python"><span>Student</span><span class="punctuation definition arguments begin python"><span>(</span></span><span class="meta function-call arguments python"><span>“</span><span>Dong</span><span>”</span></span><span class="punctuation definition arguments end python"><span>)</span></span></span><span>&nbsp;］</span></span></div></pre>
<p>List can also be created by list comprehensions. List comprehension is a description about what list should be created. It contains two parts: one is what the items in the list will be like, the other is how to get them.</p>
<pre class="editor-colors lang-python"><div class="line"><span class="source python"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="support type python"><span>list</span></span><span>&nbsp;</span><span class="keyword operator assignment python"><span>=</span></span><span>&nbsp;</span><span class="meta structure list python"><span class="punctuation definition list begin python"><span>[</span></span><span>&nbsp;</span><span class="meta structure list item python"><span>x</span><span class="keyword operator arithmetic python"><span>+</span></span><span>y</span><span>&nbsp;</span><span class="keyword control repeat python"><span>for</span></span><span>&nbsp;</span><span>x</span><span>&nbsp;</span><span class="keyword operator logical python"><span>in</span></span><span>&nbsp;‘</span><span>one</span><span>’&nbsp;</span><span class="keyword control repeat python"><span>for</span></span><span>&nbsp;</span><span>y</span><span>&nbsp;</span><span class="keyword operator logical python"><span>in</span></span><span>&nbsp;’</span><span>two</span><span>’</span></span><span class="punctuation definition list end python"><span>]</span></span></span></span></div><div class="line"><span class="source python"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword operator comparison python"><span>&gt;</span><span>&gt;</span><span>&gt;</span></span><span>&nbsp;</span><span class="support type python"><span>list</span></span></span></div><div class="line"><span class="source python"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword operator comparison python"><span>&gt;</span><span>&gt;</span><span>&gt;</span></span><span>&nbsp;</span><span class="meta structure list python"><span class="punctuation definition list begin python"><span>[</span></span><span class="meta structure list item python"><span>‘</span><span>ot</span><span>’</span></span><span class="punctuation separator list python"><span>,</span></span><span class="meta structure list item python"><span>’</span><span>ow</span><span>’</span></span><span class="punctuation separator list python"><span>,</span></span><span class="meta structure list item python"><span>’</span><span>oo</span><span>’</span></span><span class="punctuation separator list python"><span>,</span></span><span class="meta structure list item python"><span>’</span><span>nt</span><span>’</span></span><span class="punctuation separator list python"><span>,</span></span><span class="meta structure list item python"><span>’</span><span>nw</span><span>’</span></span><span class="punctuation separator list python"><span>,</span></span><span class="meta structure list item python"><span>’</span><span>no</span><span>’</span></span><span class="punctuation separator list python"><span>,</span></span><span class="meta structure list item python"><span>’</span><span>et</span><span>’</span></span><span class="punctuation separator list python"><span>,</span></span><span class="meta structure list item python"><span>’</span><span>ew</span><span>’</span></span><span class="punctuation separator list python"><span>,</span></span><span class="meta structure list item python"><span>’</span><span>eo</span><span>’</span></span><span class="punctuation definition list end python"><span>]</span></span></span></span></div></pre>
<p><b>Iterating over a Python list:</b></p>
<p><i>for-in</i> statement in Python can easily perform list iterating.</p>
<pre class="editor-colors lang-python"><div class="line"><span class="source python"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="support type python"><span>list</span></span><span>&nbsp;</span><span class="keyword operator assignment python"><span>=</span></span><span>&nbsp;</span><span class="meta structure list python"><span class="punctuation definition list begin python"><span>[</span></span><span class="meta structure list item python"><span class="constant numeric integer decimal python"><span>1</span></span></span><span class="punctuation separator list python"><span>,</span></span><span>&nbsp;</span><span class="meta structure list item python"><span class="constant numeric integer decimal python"><span>2</span></span></span><span class="punctuation separator list python"><span>,</span></span><span>&nbsp;</span><span class="meta structure list item python"><span class="constant numeric integer decimal python"><span>3</span></span></span><span class="punctuation separator list python"><span>,</span></span><span>&nbsp;</span><span class="meta structure list item python"><span class="constant numeric integer decimal python"><span>4</span></span></span><span class="punctuation definition list end python"><span>]</span></span></span></span></div><div class="line"><span class="source python"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control repeat python"><span>for</span></span><span>&nbsp;</span><span>item</span><span>&nbsp;</span><span class="keyword operator logical python"><span>in</span></span><span>&nbsp;</span><span class="support type python"><span>list</span></span><span>:</span></span></div><div class="line"><span class="source python"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword other python"><span>print</span></span><span>&nbsp;</span><span>(</span><span>item</span><span>)</span></span></div><div class="line"><span class="source python"><span>&nbsp;</span></span></div><div class="line"><span class="source python"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword operator comparison python"><span>&gt;</span><span>&gt;</span><span>&gt;</span></span><span class="constant numeric integer decimal python"><span>1</span></span></span></div><div class="line"><span class="source python"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="constant numeric integer decimal python"><span>2</span></span></span></div><div class="line"><span class="source python"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="constant numeric integer decimal python"><span>3</span></span></span></div><div class="line"><span class="source python"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="constant numeric integer decimal python"><span>4</span></span></span></div></pre>
<h2 id="assemble-code">Assemble Code</h2>
<p><b>Python Code:</b></p>
<pre class="editor-colors lang-python"><div class="line"><span class="source python"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="support type python"><span>list</span></span><span>&nbsp;</span><span class="keyword operator assignment python"><span>=</span></span><span>&nbsp;</span><span class="meta structure list python"><span class="punctuation definition list begin python"><span>[</span></span><span class="meta structure list item python"><span class="constant numeric integer decimal python"><span>1</span></span></span><span class="punctuation separator list python"><span>,</span></span><span>&nbsp;</span><span class="meta structure list item python"><span class="constant numeric integer decimal python"><span>2</span></span></span><span class="punctuation separator list python"><span>,</span></span><span>&nbsp;</span><span class="meta structure list item python"><span class="constant numeric integer decimal python"><span>3</span></span></span><span class="punctuation separator list python"><span>,</span></span><span>&nbsp;</span><span class="meta structure list item python"><span class="constant numeric integer decimal python"><span>4</span></span></span><span class="punctuation definition list end python"><span>]</span></span></span></span></div><div class="line"><span class="source python"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control repeat python"><span>for</span></span><span>&nbsp;</span><span>item</span><span>&nbsp;</span><span class="keyword operator logical python"><span>in</span></span><span>&nbsp;</span><span class="support type python"><span>list</span></span><span>:</span></span></div><div class="line"><span class="source python"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword other python"><span>print</span></span><span>&nbsp;</span><span>(</span><span>item</span><span>)</span></span></div></pre>
<p><b>Assemble Code:</b>
Then we can compile Python code to Python Bytecode and display the disassembled Bytecode by command line:</p>
<pre class="editor-colors lang-text"><div class="line"><span class="text plain"><span class="meta paragraph text"><span>python&nbsp;-m&nbsp;dis&nbsp;filename.py</span></span></span></div></pre><p>The resulting assemble code is listed below:</p>
<pre class="editor-colors lang-python"><div class="line"><span class="source python"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="constant numeric integer decimal python"><span>1</span></span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="constant numeric integer decimal python"><span>0</span></span><span>&nbsp;</span><span>LOAD_CONST</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="constant numeric integer decimal python"><span>0</span></span><span>&nbsp;</span><span>(</span><span class="constant numeric integer decimal python"><span>1</span></span><span>)</span></span></div><div class="line"><span class="source python"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="constant numeric integer decimal python"><span>3</span></span><span>&nbsp;</span><span>LOAD_CONST</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="constant numeric integer decimal python"><span>1</span></span><span>&nbsp;</span><span>(</span><span class="constant numeric integer decimal python"><span>2</span></span><span>)</span></span></div><div class="line"><span class="source python"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="constant numeric integer decimal python"><span>6</span></span><span>&nbsp;</span><span>LOAD_CONST</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="constant numeric integer decimal python"><span>2</span></span><span>&nbsp;</span><span>(</span><span class="constant numeric integer decimal python"><span>3</span></span><span>)</span></span></div><div class="line"><span class="source python"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="constant numeric integer decimal python"><span>9</span></span><span>&nbsp;</span><span>LOAD_CONST</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="constant numeric integer decimal python"><span>3</span></span><span>&nbsp;</span><span>(</span><span class="constant numeric integer decimal python"><span>4</span></span><span>)</span></span></div><div class="line"><span class="source python"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="constant numeric integer decimal python"><span>12</span></span><span>&nbsp;</span><span>BUILD_LIST</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="constant numeric integer decimal python"><span>4</span></span></span></div><div class="line"><span class="source python"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="constant numeric integer decimal python"><span>15</span></span><span>&nbsp;</span><span>STORE_NAME</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="constant numeric integer decimal python"><span>0</span></span><span>&nbsp;</span><span>(</span><span class="support type python"><span>list</span></span><span>)</span></span></div><div class="line"><span class="source python"><span>&nbsp;</span></span></div><div class="line"><span class="source python"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="constant numeric integer decimal python"><span>2</span></span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="constant numeric integer decimal python"><span>18</span></span><span>&nbsp;</span><span>SETUP_LOOP</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="constant numeric integer decimal python"><span>19</span></span><span>&nbsp;</span><span>(</span><span>to</span><span>&nbsp;</span><span class="constant numeric integer decimal python"><span>40</span></span><span>)</span></span></div><div class="line"><span class="source python"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="constant numeric integer decimal python"><span>21</span></span><span>&nbsp;</span><span>LOAD_NAME</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="constant numeric integer decimal python"><span>0</span></span><span>&nbsp;</span><span>(</span><span class="support type python"><span>list</span></span><span>)</span></span></div><div class="line"><span class="source python"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="constant numeric integer decimal python"><span>24</span></span><span>&nbsp;</span><span>GET_ITER</span></span></div><div class="line"><span class="source python"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword operator comparison python"><span>&gt;</span><span>&gt;</span></span><span>&nbsp;&nbsp;&nbsp;</span><span class="constant numeric integer decimal python"><span>25</span></span><span>&nbsp;</span><span>FOR_ITER</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="constant numeric integer decimal python"><span>11</span></span><span>&nbsp;</span><span>(</span><span>to</span><span>&nbsp;</span><span class="constant numeric integer decimal python"><span>39</span></span><span>)</span></span></div><div class="line"><span class="source python"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="constant numeric integer decimal python"><span>28</span></span><span>&nbsp;</span><span>STORE_NAME</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="constant numeric integer decimal python"><span>1</span></span><span>&nbsp;</span><span>(</span><span>item</span><span>)</span></span></div><div class="line"><span class="source python"><span>&nbsp;</span></span></div><div class="line"><span class="source python"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="constant numeric integer decimal python"><span>3</span></span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="constant numeric integer decimal python"><span>31</span></span><span>&nbsp;</span><span>LOAD_NAME</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="constant numeric integer decimal python"><span>1</span></span><span>&nbsp;</span><span>(</span><span>item</span><span>)</span></span></div><div class="line"><span class="source python"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="constant numeric integer decimal python"><span>34</span></span><span>&nbsp;</span><span>PRINT_ITEM</span></span></div><div class="line"><span class="source python"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="constant numeric integer decimal python"><span>35</span></span><span>&nbsp;</span><span>PRINT_NEWLINE</span></span></div><div class="line"><span class="source python"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="constant numeric integer decimal python"><span>36</span></span><span>&nbsp;</span><span>JUMP_ABSOLUTE</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="constant numeric integer decimal python"><span>25</span></span></span></div><div class="line"><span class="source python"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword operator comparison python"><span>&gt;</span><span>&gt;</span></span><span>&nbsp;&nbsp;&nbsp;</span><span class="constant numeric integer decimal python"><span>39</span></span><span>&nbsp;</span><span>POP_BLOCK</span></span></div><div class="line"><span class="source python"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword operator comparison python"><span>&gt;</span><span>&gt;</span></span><span>&nbsp;&nbsp;&nbsp;</span><span class="constant numeric integer decimal python"><span>40</span></span><span>&nbsp;</span><span>LOAD_CONST</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="constant numeric integer decimal python"><span>4</span></span><span>&nbsp;</span><span>(</span><span class="constant language python"><span>None</span></span><span>)</span></span></div><div class="line"><span class="source python"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="constant numeric integer decimal python"><span>43</span></span><span>&nbsp;</span><span>RETURN_VALUE</span></span></div></pre>
<h2 id="execution-framework">Execution Framework</h2>
<p>The execution process of iterating the list can be visualized on &lt;a <a href="http://pythontutor.com/&quot;&gt;Python">http://pythontutor.com/"&gt;Python</a> Tutorial. Python frame will first create a list contains 4 items and push the list to the execution stack. Then iterator will return items one by one each time when <i>FOR_ITER</i> is executed. The frame will push the item into stack and <i>PRINT_ITEM</i> will pop the item out and display it on screen.</p>
<p><img src="/Users/urcs/Course/DL/dongchen-coder.github.io/1.png" alt="Alt text"></p>
<p><img src="/Users/urcs/Course/DL/dongchen-coder.github.io/2.png" alt="Alt text"></p>
<p>By given a Python code, it will first be compiled to Python Bytecode. Then the interpreter of Python will execute the Python Bytecode. The framework of Python interpreter is listed below. First, the frame will load the code into PyCodeObject <i>co</i>. Then the pointer <i>first_isntr</i> is pointed to the start address of the code. The address of the next instruction is calculated and stored into <i>next_instr</i>. Finally, offset is updated, instruction is got out to <i>opcode</i> and the pointer <i>next_instr</i> is increased by one. Now the <i>opcode</i> can be executed by one of the branches of <i>switch</i>.</p>
<pre class="editor-colors lang-c"><div class="line"><span class="source c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...</span></span></div><div class="line"><span class="source c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;co&nbsp;=&nbsp;f-&gt;f_code;</span></span></div><div class="line"><span class="source c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;first_instr&nbsp;=&nbsp;(</span><span class="storage type c"><span>unsigned</span></span><span>&nbsp;</span><span class="storage type c"><span>char</span></span><span>*)</span></span></div><div class="line"><span class="source c"><span class="meta function c"><span class="punctuation whitespace function leading c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="entity name function c"><span>PyString_AS_STRING</span></span><span class="meta parens c"><span class="punctuation section parens begin c"><span>(</span></span><span>co-&gt;co_code</span><span class="punctuation section parens end c"><span>)</span></span></span><span>;</span></span></span></div><div class="line"><span class="source c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next_instr&nbsp;=&nbsp;first_instr&nbsp;+&nbsp;f-&gt;f_lasti&nbsp;+&nbsp;</span><span class="constant numeric c"><span>1</span></span><span>;</span></span></div><div class="line"><span class="source c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control c"><span>for</span></span><span>&nbsp;(;;)&nbsp;</span><span class="meta block c"><span class="punctuation section block begin c"><span>{</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f-&gt;f_lasti&nbsp;=</span><span class="meta function-call c"><span class="punctuation whitespace function-call leading c"><span>&nbsp;</span></span><span class="support function any-method c"><span>INSTR_OFFSET</span></span><span>(</span></span><span>);&nbsp;</span><span class="comment block c"><span class="punctuation definition comment begin c"><span>/*</span></span><span>f-&gt;f_lasti&nbsp;=&nbsp;next_instr&nbsp;-&nbsp;first_instr&nbsp;</span><span class="punctuation definition comment end c"><span>*/</span></span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;opcode&nbsp;=&nbsp;*next_instr++;</span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control c"><span>switch</span></span><span class="meta initialization c"><span>&nbsp;</span><span class="punctuation definition parameters c"><span>(</span></span></span><span>opcode)&nbsp;</span><span class="meta block c"><span class="punctuation section block begin c"><span>{</span></span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="meta block c"><span class="meta function-call c"><span class="punctuation whitespace function-call leading c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="support function any-method c"><span>case</span></span><span>&nbsp;(</span></span><span>LOAD_CONST):&nbsp;...&nbsp;</span><span class="keyword control c"><span>continue</span></span><span>;</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="meta block c"><span>&nbsp;</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="meta block c"><span class="meta function-call c"><span class="punctuation whitespace function-call leading c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="support function any-method c"><span>case</span></span><span>&nbsp;(</span></span><span>...):&nbsp;...&nbsp;</span><span class="keyword control c"><span>break</span></span><span>;</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="meta block c"><span>&nbsp;</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="meta block c"><span class="meta function-call c"><span class="punctuation whitespace function-call leading c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="support function any-method c"><span>case</span></span><span>&nbsp;(</span></span><span>GET_ITER):&nbsp;...</span><span class="meta function-call c"><span class="support function any-method c"><span>PREDICT</span></span><span>(</span></span><span>FOR_ITER);&nbsp;</span><span class="keyword control c"><span>continue</span></span><span>;</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="meta block c"><span>&nbsp;</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="meta block c"><span class="meta function-call c"><span class="punctuation whitespace function-call leading c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="support function any-method c"><span>PREDICTED_WITH_ARG</span></span><span>(</span></span><span>FOR_ITER);</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="meta block c"><span class="meta function-call c"><span class="punctuation whitespace function-call leading c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="support function any-method c"><span>case</span></span><span>&nbsp;(</span></span><span>FOR_ITER):&nbsp;...&nbsp;</span><span class="keyword control c"><span>continue</span></span><span>;</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="meta block c"><span>&nbsp;</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="meta block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="meta block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation section block end c"><span>}</span></span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation section block end c"><span>}</span></span></span></span></div></pre>
<p>We can see in the <i>switch</i> statements, there are a lot of <i>PREDICT()</i>, <i>PREDICTED()</i> and <i>PREDITED_WITH_ARG()</i> macros are defined. These macros are used in pairs. <i>PREDICT()</i> will guess the next operation, if the next operation is <i>op</i>, it means that the prediction is successful and can directly jump to the <i>PREDICTED()</i> or <i>PREDITED_WITH_ARG()</i> which actually defines the label.</p>
<pre class="editor-colors lang-c"><div class="line"><span class="source c"><span class="meta preprocessor macro c"><span>&nbsp;&nbsp;&nbsp;&nbsp;#</span><span class="keyword control import define c"><span>define</span></span><span>&nbsp;</span><span class="entity name function preprocessor c"><span>PREDICT</span></span><span class="punctuation definition parameters begin c"><span>(</span></span><span class="variable parameter preprocessor c"><span>op</span></span><span class="punctuation definition parameters end c"><span>)</span></span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control c"><span>if</span></span><span>&nbsp;(*next_instr&nbsp;==&nbsp;op)&nbsp;</span><span class="keyword control c"><span>goto</span></span><span>&nbsp;PRED_##op</span></span></span></div><div class="line"><span class="source c"><span class="meta preprocessor macro c"><span>&nbsp;&nbsp;&nbsp;&nbsp;#</span><span class="keyword control import define c"><span>define</span></span><span>&nbsp;</span><span class="entity name function preprocessor c"><span>PREDICTED</span></span><span class="punctuation definition parameters begin c"><span>(</span></span><span class="variable parameter preprocessor c"><span>op</span></span><span class="punctuation definition parameters end c"><span>)</span></span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PRED_##op:&nbsp;next_instr++</span></span></span></div><div class="line"><span class="source c"><span class="meta preprocessor macro c"><span>&nbsp;&nbsp;&nbsp;&nbsp;#</span><span class="keyword control import define c"><span>define</span></span><span>&nbsp;</span><span class="entity name function preprocessor c"><span>PREDICTED_WITH_ARG</span></span><span class="punctuation definition parameters begin c"><span>(</span></span><span class="variable parameter preprocessor c"><span>op</span></span><span class="punctuation definition parameters end c"><span>)</span></span><span>&nbsp;&nbsp;PRED_##op:&nbsp;oparg&nbsp;=&nbsp;PEEKARG();&nbsp;next_instr&nbsp;+=&nbsp;</span><span class="constant numeric c"><span>3</span></span></span></span></div></pre>
<h2 id="python-bytecode-for-iterating">Python Bytecode for Iterating</h2>
<p>There are four Python Bytecodes that implemented the iterating function of Python: SETUP_LOOP, GET_ITER, FOR_ITER and JUMP_ABSOLUTE.</p>
<p><b>SETUP_LOOP</b></p>
<pre class="editor-colors lang-c"><div class="line"><span class="source c"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control c"><span>case</span></span><span>&nbsp;SETUP_LOOP:</span></span></div><div class="line"><span class="source c"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control c"><span>case</span></span><span>&nbsp;SETUP_EXCEPT:</span></span></div><div class="line"><span class="source c"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control c"><span>case</span></span><span>&nbsp;SETUP_FINALLY:</span></span></div><div class="line"><span class="source c"><span class="meta function c"><span class="punctuation whitespace function leading c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="entity name function c"><span>PyFrame_BlockSetup</span></span><span class="meta parens c"><span class="punctuation section parens begin c"><span>(</span></span><span>f,&nbsp;opcode,&nbsp;INSTR_OFFSET(</span><span class="punctuation section parens end c"><span>)</span></span></span><span>&nbsp;+&nbsp;oparg,&nbsp;STACK_LEVEL</span><span class="meta parens c"><span class="punctuation section parens begin c"><span>(</span></span><span class="punctuation section parens end c"><span>)</span></span></span><span>)</span><span>;</span></span></span></div><div class="line"><span class="source c"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control c"><span>continue</span></span><span>;</span></span></div></pre>
<p>SETUP_LOOP is to create a basic block which contains the body of the loop. It will create a block object which maintains the exit address of the next instruction should be executed when the block pop out of the block stack. <i>INSTR_OFFSET() + oparg</i> calculates the exit address. <i>opcode</i> is the value of macro SETUP_LOOP, SETUP_EXCEPT or SETUP_FINALLY which will be recorded by the Python block object.</p>
<p><b>GET_ITER</b></p>
<pre class="editor-colors lang-c"><div class="line"><span class="source c"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control c"><span>case</span></span><span>&nbsp;GET_ITER:</span></span></div><div class="line"><span class="source c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v&nbsp;=&nbsp;TOP();</span></span></div><div class="line"><span class="source c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x&nbsp;=&nbsp;PyObject_GetIter(v);</span></span></div><div class="line"><span class="source c"><span class="meta function c"><span class="punctuation whitespace function leading c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="entity name function c"><span>Py_DECREF</span></span><span class="meta parens c"><span class="punctuation section parens begin c"><span>(</span></span><span>v</span><span class="punctuation section parens end c"><span>)</span></span></span><span>;</span></span></span></div><div class="line"><span class="source c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control c"><span>if</span></span><span>&nbsp;(x&nbsp;!=&nbsp;</span><span class="constant language c"><span>NULL</span></span><span>)&nbsp;</span><span class="meta block c"><span class="punctuation section block begin c"><span>{</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="meta function-call c"><span class="punctuation whitespace function-call leading c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="support function any-method c"><span>SET_TOP</span></span><span>(</span></span><span>x);</span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="meta function-call c"><span class="punctuation whitespace function-call leading c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="support function any-method c"><span>PREDICT</span></span><span>(</span></span><span>FOR_ITER);</span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control c"><span>continue</span></span><span>;</span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation section block end c"><span>}</span></span></span></span></div><div class="line"><span class="source c"><span class="meta function c"><span class="punctuation whitespace function leading c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="entity name function c"><span>STACKADJ</span></span><span class="meta parens c"><span class="punctuation section parens begin c"><span>(</span></span><span>-</span><span class="constant numeric c"><span>1</span></span><span class="punctuation section parens end c"><span>)</span></span></span><span>;</span></span></span></div><div class="line"><span class="source c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control c"><span>break</span></span><span>;</span></span></div></pre>
<p>GET_ITER is to get the iterator object for whatever object on the top of the execution stack. If the top object does not have an iterator object, the top object will be popped out of the stack. Else <i>PyObject_GetIter()</i> will return the iterator. The function which can return the iterators are implemented in Python type object, each Python type has its own iterator method whose entrance can be found by <i>t-&gt;tp_iter</i>.</p>
<pre class="editor-colors lang-c"><div class="line"><span class="source c"><span>&nbsp;&nbsp;&nbsp;&nbsp;PyObject&nbsp;*</span><span class="meta function c"><span class="punctuation whitespace function leading c"><span>&nbsp;</span></span><span class="entity name function c"><span>PyObject_GetIter</span></span><span class="meta parens c"><span class="punctuation section parens begin c"><span>(</span></span><span>PyObject&nbsp;*o</span><span class="punctuation section parens end c"><span>)</span></span></span><span>&nbsp;</span><span class="meta block c"><span class="punctuation section block begin c"><span>{</span></span></span></span></span></div><div class="line"><span class="source c"><span class="meta function c"><span class="meta block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PyTypeObject&nbsp;*t&nbsp;=&nbsp;o-&gt;ob_type;</span></span></span></span></div><div class="line"><span class="source c"><span class="meta function c"><span class="meta block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f&nbsp;=&nbsp;t-&gt;tp_iter;</span></span></span></span></div><div class="line"><span class="source c"><span class="meta function c"><span class="meta block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PyObject&nbsp;*res&nbsp;=&nbsp;(*f)(o);&nbsp;&nbsp;&nbsp;</span><span class="comment block c"><span class="punctuation definition comment begin c"><span>/*</span></span><span>&nbsp;list_iter()&nbsp;</span><span class="punctuation definition comment end c"><span>*/</span></span></span></span></span></span></div><div class="line"><span class="source c"><span class="meta function c"><span class="meta block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control c"><span>return</span></span><span>&nbsp;res;</span></span></span></span></div><div class="line"><span class="source c"><span class="meta function c"><span class="meta block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation section block end c"><span>}</span></span></span></span></span></div></pre>
<p>For Python list object, based on the definition of PyList_Type the function entrance got by <i>t-&gt;tp_iter</i> is <i>list_iter</i>. <i>list_iter&lt;\i&gt; will create a list iterator object which contains both the index and pointer to the original list object.</i></p>
<pre class="editor-colors lang-c"><div class="line"><span class="source c"><span>&nbsp;&nbsp;&nbsp;&nbsp;PyTypeObject&nbsp;PyList_Type&nbsp;=&nbsp;</span><span class="meta block c"><span class="punctuation section block begin c"><span>{</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;...</span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;list_iter,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="comment block c"><span class="punctuation definition comment begin c"><span>/*</span></span><span>&nbsp;tp_iter&nbsp;</span><span class="punctuation definition comment end c"><span>*/</span></span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="constant numeric c"><span>0</span></span><span>,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="comment block c"><span class="punctuation definition comment begin c"><span>/*</span></span><span>&nbsp;tp_iternext&nbsp;</span><span class="punctuation definition comment end c"><span>*/</span></span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;list_methods,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="comment block c"><span class="punctuation definition comment begin c"><span>/*</span></span><span>&nbsp;tp_methods&nbsp;</span><span class="punctuation definition comment end c"><span>*/</span></span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;...</span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation section block end c"><span>}</span></span></span><span>;</span></span></div><div class="line"><span class="source c"><span>&nbsp;</span></span></div><div class="line"><span class="source c"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier c"><span>static</span></span><span>&nbsp;PyObject&nbsp;*</span><span class="meta function c"><span class="punctuation whitespace function leading c"><span>&nbsp;</span></span><span class="entity name function c"><span>list_iter</span></span><span class="meta parens c"><span class="punctuation section parens begin c"><span>(</span></span><span>PyObject&nbsp;*seq</span><span class="punctuation section parens end c"><span>)</span></span></span></span></span></div><div class="line"><span class="source c"><span class="meta function c"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="meta block c"><span class="punctuation section block begin c"><span>{</span></span></span></span></span></div><div class="line"><span class="source c"><span class="meta function c"><span class="meta block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;listiterobject&nbsp;*it;</span></span></span></span></div><div class="line"><span class="source c"><span class="meta function c"><span class="meta block c"><span>&nbsp;</span></span></span></span></div><div class="line"><span class="source c"><span class="meta function c"><span class="meta block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control c"><span>if</span></span><span class="meta initialization c"><span>&nbsp;</span><span class="punctuation definition parameters c"><span>(</span></span></span><span>!</span><span class="meta function-call c"><span class="support function any-method c"><span>PyList_Check</span></span><span>(</span></span><span>seq))&nbsp;</span><span class="meta block c"><span class="punctuation section block begin c"><span>{</span></span></span></span></span></span></div><div class="line"><span class="source c"><span class="meta function c"><span class="meta block c"><span class="meta block c"><span class="meta function-call c"><span class="punctuation whitespace function-call leading c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="support function any-method c"><span>PyErr_BadInternalCall</span></span><span>(</span></span><span>);</span></span></span></span></span></div><div class="line"><span class="source c"><span class="meta function c"><span class="meta block c"><span class="meta block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control c"><span>return</span></span><span>&nbsp;</span><span class="constant language c"><span>NULL</span></span><span>;</span></span></span></span></span></div><div class="line"><span class="source c"><span class="meta function c"><span class="meta block c"><span class="meta block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation section block end c"><span>}</span></span></span></span></span></span></div><div class="line"><span class="source c"><span class="meta function c"><span class="meta block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;it&nbsp;=</span><span class="meta function-call c"><span class="punctuation whitespace function-call leading c"><span>&nbsp;</span></span><span class="support function any-method c"><span>PyObject_GC_New</span></span><span>(</span></span><span>listiterobject,&nbsp;&amp;PyListIter_Type);</span></span></span></span></div><div class="line"><span class="source c"><span class="meta function c"><span class="meta block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control c"><span>if</span></span><span class="meta initialization c"><span>&nbsp;</span><span class="punctuation definition parameters c"><span>(</span></span></span><span>it&nbsp;==&nbsp;</span><span class="constant language c"><span>NULL</span></span><span>)</span></span></span></span></div><div class="line"><span class="source c"><span class="meta function c"><span class="meta block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control c"><span>return</span></span><span>&nbsp;</span><span class="constant language c"><span>NULL</span></span><span>;</span></span></span></span></div><div class="line"><span class="source c"><span class="meta function c"><span class="meta block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;it-&gt;it_index&nbsp;=&nbsp;</span><span class="constant numeric c"><span>0</span></span><span>;</span></span></span></span></div><div class="line"><span class="source c"><span class="meta function c"><span class="meta block c"><span class="meta function-call c"><span class="punctuation whitespace function-call leading c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="support function any-method c"><span>Py_INCREF</span></span><span>(</span></span><span>seq);</span></span></span></span></div><div class="line"><span class="source c"><span class="meta function c"><span class="meta block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;it-&gt;it_seq&nbsp;=&nbsp;(PyListObject&nbsp;*)seq;</span></span></span></span></div><div class="line"><span class="source c"><span class="meta function c"><span class="meta block c"><span class="meta function-call c"><span class="punctuation whitespace function-call leading c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="support function any-method c"><span>_PyObject_GC_TRACK</span></span><span>(</span></span><span>it);</span></span></span></span></div><div class="line"><span class="source c"><span class="meta function c"><span class="meta block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control c"><span>return</span></span><span>&nbsp;(PyObject&nbsp;*)it;</span></span></span></span></div><div class="line"><span class="source c"><span class="meta function c"><span class="meta block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation section block end c"><span>}</span></span></span></span></span></div></pre>
<p><b>FOR_ITER</b></p>
<pre class="editor-colors lang-c"><div class="line"><span class="source c"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control c"><span>case</span></span><span>&nbsp;FOR_ITER:</span></span></div><div class="line"><span class="source c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v&nbsp;=&nbsp;TOP();</span></span></div><div class="line"><span class="source c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x&nbsp;=&nbsp;(*v-&gt;ob_type-&gt;tp_iternext)(v);</span></span></div><div class="line"><span class="source c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control c"><span>if</span></span><span>&nbsp;(x&nbsp;!=&nbsp;</span><span class="constant language c"><span>NULL</span></span><span>)&nbsp;</span><span class="meta block c"><span class="punctuation section block begin c"><span>{</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="meta function-call c"><span class="punctuation whitespace function-call leading c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="support function any-method c"><span>PUSH</span></span><span>(</span></span><span>x);</span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="meta function-call c"><span class="punctuation whitespace function-call leading c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="support function any-method c"><span>PREDICT</span></span><span>(</span></span><span>STORE_FAST);</span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="meta function-call c"><span class="punctuation whitespace function-call leading c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="support function any-method c"><span>PREDICT</span></span><span>(</span></span><span>UNPACK_SEQUENCE);</span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control c"><span>continue</span></span><span>;</span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation section block end c"><span>}</span></span></span></span></div><div class="line"><span class="source c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control c"><span>if</span></span><span>&nbsp;(PyErr_Occurred())&nbsp;</span><span class="meta block c"><span class="punctuation section block begin c"><span>{</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control c"><span>if</span></span><span class="meta initialization c"><span>&nbsp;</span><span class="punctuation definition parameters c"><span>(</span></span></span><span>!</span><span class="meta function-call c"><span class="support function any-method c"><span>PyErr_ExceptionMatches</span></span><span>(</span></span><span>PyExc_StopIteration))</span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control c"><span>break</span></span><span>;</span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span class="meta function-call c"><span class="punctuation whitespace function-call leading c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="support function any-method c"><span>PyErr_Clear</span></span><span>(</span></span><span>);</span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation section block end c"><span>}</span></span></span></span></div><div class="line"><span class="source c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x&nbsp;=&nbsp;v&nbsp;=&nbsp;POP();</span></span></div><div class="line"><span class="source c"><span class="meta function c"><span class="punctuation whitespace function leading c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="entity name function c"><span>Py_DECREF</span></span><span class="meta parens c"><span class="punctuation section parens begin c"><span>(</span></span><span>v</span><span class="punctuation section parens end c"><span>)</span></span></span><span>;</span></span></span></div><div class="line"><span class="source c"><span class="meta function c"><span class="punctuation whitespace function leading c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="entity name function c"><span>JUMPBY</span></span><span class="meta parens c"><span class="punctuation section parens begin c"><span>(</span></span><span>oparg</span><span class="punctuation section parens end c"><span>)</span></span></span><span>;</span></span></span></div><div class="line"><span class="source c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control c"><span>continue</span></span><span>;</span></span></div></pre>
<p>FOR_ITER is actually to let the iterator return the next object and push it into stack. If iterator has reached the end, NULL will be returned. Then the iterator object will be popped out and jump to the operation with address of next operation add an offset <i>oparg</i> which will exit the iteration. The way to get the entrance to the next method of iterators works the same way as getting the entrance of the function which returns the iterator. The next method are implemented in the Python type object and the entrance of the next method can be get by <i>type-&gt;tp_iternext</i>.</p>
<pre class="editor-colors lang-c"><div class="line"><span class="source c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PyTypeObject&nbsp;PyListIter_Type&nbsp;=&nbsp;</span><span class="meta block c"><span class="punctuation section block begin c"><span>{</span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...</span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PyObject_SelfIter,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="comment block c"><span class="punctuation definition comment begin c"><span>/*</span></span><span>&nbsp;tp_iter&nbsp;</span><span class="punctuation definition comment end c"><span>*/</span></span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(iternextfunc)listiter_next,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="comment block c"><span class="punctuation definition comment begin c"><span>/*</span></span><span>&nbsp;tp_iternext&nbsp;</span><span class="punctuation definition comment end c"><span>*/</span></span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;listiter_methods,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="comment block c"><span class="punctuation definition comment begin c"><span>/*</span></span><span>&nbsp;tp_methods&nbsp;</span><span class="punctuation definition comment end c"><span>*/</span></span></span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...</span></span></span></div><div class="line"><span class="source c"><span class="meta block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation section block end c"><span>}</span></span></span><span>;</span></span></div></pre>
<p>For Python list object, the <i>tp_iternext</i> method is <i>listiter_next</i>. It will return the item in list with index <i>it_index</i> and increase the index. If the index equals to the length of the list size, it means the iterator has reached the end and NULL will be returned.</p>
<pre class="editor-colors lang-c"><div class="line"><span class="source c"><span class="meta function c"><span class="punctuation whitespace function leading c"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="entity name function c"><span>listiter_next</span></span><span class="meta parens c"><span class="punctuation section parens begin c"><span>(</span></span><span>listiterobject&nbsp;*it</span><span class="punctuation section parens end c"><span>)</span></span></span></span></span></div><div class="line"><span class="source c"><span class="meta function c"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="meta block c"><span class="punctuation section block begin c"><span>{</span></span></span></span></span></div><div class="line"><span class="source c"><span class="meta function c"><span class="meta block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PyListObject&nbsp;*seq;</span></span></span></span></div><div class="line"><span class="source c"><span class="meta function c"><span class="meta block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PyObject&nbsp;*item;</span></span></span></span></div><div class="line"><span class="source c"><span class="meta function c"><span class="meta block c"><span>&nbsp;</span></span></span></span></div><div class="line"><span class="source c"><span class="meta function c"><span class="meta block c"><span class="punctuation whitespace support function leading c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="support function C99 c"><span>assert</span></span><span>(it&nbsp;!=&nbsp;</span><span class="constant language c"><span>NULL</span></span><span>);</span></span></span></span></div><div class="line"><span class="source c"><span class="meta function c"><span class="meta block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;seq&nbsp;=&nbsp;it-&gt;it_seq;</span></span></span></span></div><div class="line"><span class="source c"><span class="meta function c"><span class="meta block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control c"><span>if</span></span><span class="meta initialization c"><span>&nbsp;</span><span class="punctuation definition parameters c"><span>(</span></span></span><span>seq&nbsp;==&nbsp;</span><span class="constant language c"><span>NULL</span></span><span>)</span></span></span></span></div><div class="line"><span class="source c"><span class="meta function c"><span class="meta block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control c"><span>return</span></span><span>&nbsp;</span><span class="constant language c"><span>NULL</span></span><span>;</span></span></span></span></div><div class="line"><span class="source c"><span class="meta function c"><span class="meta block c"><span class="punctuation whitespace support function leading c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="support function C99 c"><span>assert</span></span><span>(</span><span class="meta function-call c"><span class="support function any-method c"><span>PyList_Check</span></span><span>(</span></span><span>seq));</span></span></span></span></div><div class="line"><span class="source c"><span class="meta function c"><span class="meta block c"><span>&nbsp;</span></span></span></span></div><div class="line"><span class="source c"><span class="meta function c"><span class="meta block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control c"><span>if</span></span><span class="meta initialization c"><span>&nbsp;</span><span class="punctuation definition parameters c"><span>(</span></span></span><span>it-&gt;it_index&nbsp;&lt;</span><span class="meta function-call c"><span class="punctuation whitespace function-call leading c"><span>&nbsp;</span></span><span class="support function any-method c"><span>PyList_GET_SIZE</span></span><span>(</span></span><span>seq))&nbsp;</span><span class="meta block c"><span class="punctuation section block begin c"><span>{</span></span></span></span></span></span></div><div class="line"><span class="source c"><span class="meta function c"><span class="meta block c"><span class="meta block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;item&nbsp;=</span><span class="meta function-call c"><span class="punctuation whitespace function-call leading c"><span>&nbsp;</span></span><span class="support function any-method c"><span>PyList_GET_ITEM</span></span><span>(</span></span><span>seq,&nbsp;it-&gt;it_index);</span></span></span></span></span></div><div class="line"><span class="source c"><span class="meta function c"><span class="meta block c"><span class="meta block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++it-&gt;it_index;</span></span></span></span></span></div><div class="line"><span class="source c"><span class="meta function c"><span class="meta block c"><span class="meta block c"><span class="meta function-call c"><span class="punctuation whitespace function-call leading c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="support function any-method c"><span>Py_INCREF</span></span><span>(</span></span><span>item);</span></span></span></span></span></div><div class="line"><span class="source c"><span class="meta function c"><span class="meta block c"><span class="meta block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control c"><span>return</span></span><span>&nbsp;item;</span></span></span></span></span></div><div class="line"><span class="source c"><span class="meta function c"><span class="meta block c"><span class="meta block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation section block end c"><span>}</span></span></span></span></span></span></div><div class="line"><span class="source c"><span class="meta function c"><span class="meta block c"><span>&nbsp;</span></span></span></span></div><div class="line"><span class="source c"><span class="meta function c"><span class="meta block c"><span class="meta function-call c"><span class="punctuation whitespace function-call leading c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="support function any-method c"><span>Py_DECREF</span></span><span>(</span></span><span>seq);</span></span></span></span></div><div class="line"><span class="source c"><span class="meta function c"><span class="meta block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;it-&gt;it_seq&nbsp;=&nbsp;</span><span class="constant language c"><span>NULL</span></span><span>;</span></span></span></span></div><div class="line"><span class="source c"><span class="meta function c"><span class="meta block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control c"><span>return</span></span><span>&nbsp;</span><span class="constant language c"><span>NULL</span></span><span>;</span></span></span></span></div><div class="line"><span class="source c"><span class="meta function c"><span class="meta block c"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation section block end c"><span>}</span></span></span></span></span></div></pre>


</body>
</html>
